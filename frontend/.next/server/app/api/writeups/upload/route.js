(()=>{var e={};e.id=6225,e.ids=[6225],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},79748:e=>{"use strict";e.exports=require("fs/promises")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},39970:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>C,routeModule:()=>b,serverHooks:()=>R,workAsyncStorage:()=>k,workUnitAsyncStorage:()=>D});var s={};t.r(s),t.d(s,{POST:()=>S});var i=t(42706),o=t(28203),a=t(45994),n=t(39187),u=t(85562),p=t(84908),c=t(33873),l=t.n(c),d=t(29021),f=t.n(d),m=t(79748),g=t(30379),w=t(80688),x=t(12963);let h=l().join(process.cwd(),"/uploads/writeups/"),v=l().join(h,"images/"),y=l().join(h,"writeup/");(0,m.mkdir)(v,{recursive:!0}),(0,m.mkdir)(y,{recursive:!0});let j=["jpg","jpeg","png","webp","svg"],q=["md","markdown"],A=g.z.object({Title:g.z.string().min(1,"Title is required"),Difficulty:g.z.string().min(1,"Difficulty is required"),Link:g.z.string().url("Invalid URL").optional(),Category:g.z.string().optional(),Topics:g.z.string().refine(e=>{try{return Array.isArray(JSON.parse(e))}catch{return!1}},"Invalid Topics format"),CTF:g.z.string().refine(e=>{try{return"object"==typeof JSON.parse(e)&&JSON.parse(e).title}catch{return!1}},"Invalid CTF format"),Description:g.z.string().min(1,"Description is required")});function I(e,r){let t=l().basename(r,l().extname(r)),s=l().extname(r),i=r,o=1;for(;f().existsSync(l().join(e,i));)i=`${t}_${o}${s}`,o++;return i}let S=async e=>{try{let r=await (0,u.j)();if(!r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let t=r.user.id,s=await e.formData(),i=Object.fromEntries(s.entries()),o=A.safeParse(i),a=s.getAll("assets");if(!o.success)return console.error(o.error.errors),n.NextResponse.json({error:"Invalid form data",issues:o.error.errors},{status:400});let{Title:c,Difficulty:l,Link:d,Category:f,Topics:g,CTF:h,Description:S}=o.data,b=JSON.parse(g),k=JSON.parse(h),D=new Map;if(console.log(a),a)for(let e of a){if(e.size>0x3200000)return n.NextResponse.json({error:"Image exceeds 20MB limit"},{status:400});let r=I(v,e.name),t=(0,w.A)(v,r,j,!1);await (0,m.writeFile)(t,Buffer.from(await e.arrayBuffer())),D.set(e.name,`${r}`)}let R=s.get("WriteupThumbnail"),C=null;if(R){if(R.size>0x3200000)return n.NextResponse.json({error:"Image exceeds 20MB limit"},{status:400});let e=I(v,R.name),r=(0,w.A)(v,e,j,!1);await (0,m.writeFile)(r,Buffer.from(await R.arrayBuffer())),C=`${e}`}let z=s.get("WriteupFile"),E=null;if(!z)return n.NextResponse.json({error:"Writeup file is required"},{status:400});{if(z.size>0x6400000)return n.NextResponse.json({error:"Markdown file exceeds 2MB limit"},{status:400});let e=I(y,z.name),r=(0,w.A)(y,e,q,!1),t=await z.text(),s=(0,x.m)(t,"/api/writeups/images/",D);await (0,m.writeFile)(r,Buffer.from(s)),E=`${e}`}let N=k.title.trim(),$=(await p.A.events.upsert({create:{userId:t,title:N,isCompetition:!0},update:{title:N},where:{title:N},select:{id:!0}})).id,O=await p.A.categories.findMany(),T=O.find(e=>e.name===f)?.id||null,F=await p.A.writeups.create({data:{title:c,difficulty:l,contentFile:E,description:S,categoryId:T,eventId:$,source:d,thumbnail:C,userId:t},select:{id:!0}});for(let e of b)await p.A.writeupstopics.create({data:{writeupId:F.id,topicId:e}});return n.NextResponse.json({status:"success",writeupId:F.id})}catch(e){return console.error(e),n.NextResponse.json({error:"Internal Server Error"},{status:500})}},b=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/writeups/upload/route",pathname:"/api/writeups/upload",filename:"route",bundlePath:"app/api/writeups/upload/route"},resolvedPagePath:"C:\\Users\\czhon\\Documents\\GitHub\\SSMCT_Website\\frontend\\src\\app\\api\\writeups\\upload\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:k,workUnitAsyncStorage:D,serverHooks:R}=b;function C(){return(0,a.patchFetch)({workAsyncStorage:k,workUnitAsyncStorage:D})}},96487:()=>{},78335:()=>{},85562:(e,r,t)=>{"use strict";t.d(r,{$:()=>u,j:()=>p});var s=t(51825),i=t(64912),o=t(86259),a=t(84908);let n=async e=>{let r=process.env.DISCORD_GUILD_ID,t=await fetch("https://discord.com/api/v10/users/@me/guilds",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw console.error("Failed to fetch user's Discord guilds"),Error("Failed to fetch user's Discord guilds");return!!(await t.json()).some(e=>e.id===r)||(console.error("User is not in the required Discord guild"),!1)},u={adapter:(0,o.y)(a.A),pages:{signIn:"/",signOut:"/auth/signout",error:"/auth/signin",newUser:"/auth/new_user"},session:{strategy:"database"},providers:[(0,i.A)({clientId:process.env.DISCORD_CLIENT_ID,clientSecret:process.env.DISCORD_CLIENT_SECRET,authorization:{params:{scope:"identify guilds guilds.members.read"}},token:"https://discord.com/api/oauth2/token",userinfo:"https://discord.com/api/users/@me",profile:e=>({id:e.id,name:e.username,image:e.avatar?`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.png`:null})})],callbacks:{async signIn({account:e,user:r}){if(!e||!r)return!1;if("discord"===e.provider){if(console.log(e),!e.access_token)return!1;if(!await n(e.access_token))throw Error("User is not in the required Discord guild")}return!0},session:async({session:e,user:r})=>(e?.user&&(e.user.id=r.id),e)}};function p(...e){return(0,s.getServerSession)(...e,u)}},84908:(e,r,t)=>{"use strict";t.d(r,{A:()=>i});var s=t(96330);let i=global.prisma||new s.PrismaClient({log:["query"]})},12963:(e,r,t)=>{"use strict";t.d(r,{m:()=>o});var s=t(33873),i=t.n(s);function o(e,r,t){return e.replace(/!\[.*?\]\((.*?)\)/g,(e,s)=>{let o=i().basename(s).toLowerCase();for(let[i,a]of t.entries())if(i.toLowerCase()===o)return e.replace(s,`${r}${a}`);return e})}},80688:(e,r,t)=>{"use strict";t.d(r,{A:()=>n});var s=t(29021),i=t.n(s),o=t(33873),a=t.n(o);function n(e,r,t,s=!0){if(!Array.isArray(t)||0===t.length)throw Error("Extensions must be a non-empty array");let o=t.join("|");if(!RegExp(`^[^/\\\\:*?"<>|]+\\.(${o})$`).test(r))throw Error(`Invalid filename. Allowed extensions: ${t.join(", ")}`);let u=a().resolve(e,r);if(!u.startsWith(e))throw Error("Invalid file path");if(s&&!i().existsSync(u))throw Error("File not found");return u}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,5452,6622,903],()=>t(39970));module.exports=s})();