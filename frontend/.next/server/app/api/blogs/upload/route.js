(()=>{var e={};e.id=1847,e.ids=[1847],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},79748:e=>{"use strict";e.exports=require("fs/promises")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},37027:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>R,routeModule:()=>S,serverHooks:()=>C,workAsyncStorage:()=>D,workUnitAsyncStorage:()=>k});var s={};t.r(s),t.d(s,{POST:()=>I});var i=t(42706),o=t(28203),a=t(45994),n=t(39187),u=t(85562),l=t(84908),c=t(33873),p=t.n(c),d=t(29021),f=t.n(d),g=t(79748),m=t(30379),x=t(80688),h=t(12963);let w=p().join(process.cwd(),"/uploads/blogs/"),v=p().join(w,"images/"),y=p().join(w,"blog/");(0,g.mkdir)(v,{recursive:!0}),(0,g.mkdir)(y,{recursive:!0});let b=["jpg","jpeg","png","webp","svg"],j=["md","markdown"],q=m.z.object({Title:m.z.string().min(1,"Title is required"),Difficulty:m.z.string().min(1,"Difficulty is required"),Category:m.z.string().optional(),Topics:m.z.string().refine(e=>{try{return Array.isArray(JSON.parse(e))}catch{return!1}},"Invalid Topics format"),CTF:m.z.string().refine(e=>{try{return"object"==typeof JSON.parse(e)&&JSON.parse(e).title}catch{return!1}},"Invalid CTF format"),Description:m.z.string().min(1,"Description is required")});function A(e,r){let t=p().basename(r,p().extname(r)),s=p().extname(r),i=r,o=1;for(;f().existsSync(p().join(e,i));)i=`${t}_${o}${s}`,o++;return i}let I=async e=>{try{let r=await (0,u.j)();if(!r)return n.NextResponse.json({error:"Unauthorized"},{status:401});let t=r.user.id,s=await e.formData(),i=Object.fromEntries(s.entries()),o=q.safeParse(i),a=s.getAll("assets");if(!o.success)return console.error(o.error.errors),n.NextResponse.json({error:"Invalid form data",issues:o.error.errors},{status:400});let{Title:c,Difficulty:p,Category:d,Topics:f,CTF:m,Description:w}=o.data,I=JSON.parse(f),S=JSON.parse(m),D=new Map;if(console.log(a),a)for(let e of a){if(e.size>0x3200000)return n.NextResponse.json({error:"Image exceeds 20MB limit"},{status:400});let r=A(v,e.name),t=(0,x.A)(v,r,b,!1);await (0,g.writeFile)(t,Buffer.from(await e.arrayBuffer())),D.set(e.name,`${r}`)}let k=s.get("BlogThumbnail"),C=null;if(k){if(k.size>0x3200000)return n.NextResponse.json({error:"Image exceeds 20MB limit"},{status:400});let e=A(v,k.name),r=(0,x.A)(v,e,b,!1);await (0,g.writeFile)(r,Buffer.from(await k.arrayBuffer())),C=`${e}`}let R=s.get("BlogFile"),z=null;if(!R)return n.NextResponse.json({error:"Blog file is required"},{status:400});{if(R.size>0x6400000)return n.NextResponse.json({error:"Markdown file exceeds 2MB limit"},{status:400});let e=A(y,R.name),r=(0,x.A)(y,e,j,!1),t=await R.text(),s=(0,h.m)(t,"/api/blogs/images/",D);await (0,g.writeFile)(r,Buffer.from(s)),z=`${e}`}let E=S.title.trim(),N=(await l.A.events.upsert({create:{userId:t,title:E,isCompetition:!0},update:{title:E},where:{title:E},select:{id:!0}})).id,$=await l.A.categories.findMany(),O=$.find(e=>e.name===d)?.id||null,T=await l.A.blogs.create({data:{title:c,difficulty:p,contentFile:z,description:w,categoryId:O,eventId:N,thumbnail:C,userId:t},select:{id:!0}});for(let e of I)await l.A.blogstopics.create({data:{blogId:T.id,topicId:e}});return n.NextResponse.json({status:"success",blogId:T.id})}catch(e){return console.error(e),n.NextResponse.json({error:"Internal Server Error"},{status:500})}},S=new i.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/blogs/upload/route",pathname:"/api/blogs/upload",filename:"route",bundlePath:"app/api/blogs/upload/route"},resolvedPagePath:"C:\\Users\\czhon\\Documents\\GitHub\\SSMCT_Website\\frontend\\src\\app\\api\\blogs\\upload\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:D,workUnitAsyncStorage:k,serverHooks:C}=S;function R(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:k})}},96487:()=>{},78335:()=>{},85562:(e,r,t)=>{"use strict";t.d(r,{$:()=>u,j:()=>l});var s=t(51825),i=t(64912),o=t(86259),a=t(84908);let n=async e=>{let r=process.env.DISCORD_GUILD_ID,t=await fetch("https://discord.com/api/v10/users/@me/guilds",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw console.error("Failed to fetch user's Discord guilds"),Error("Failed to fetch user's Discord guilds");return!!(await t.json()).some(e=>e.id===r)||(console.error("User is not in the required Discord guild"),!1)},u={adapter:(0,o.y)(a.A),pages:{signIn:"/",signOut:"/auth/signout",error:"/auth/signin",newUser:"/auth/new_user"},session:{strategy:"database"},providers:[(0,i.A)({clientId:process.env.DISCORD_CLIENT_ID,clientSecret:process.env.DISCORD_CLIENT_SECRET,authorization:{params:{scope:"identify guilds guilds.members.read"}},token:"https://discord.com/api/oauth2/token",userinfo:"https://discord.com/api/users/@me",profile:e=>({id:e.id,name:e.username,image:e.avatar?`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.png`:null})})],callbacks:{async signIn({account:e,user:r}){if(!e||!r)return!1;if("discord"===e.provider){if(console.log(e),!e.access_token)return!1;if(!await n(e.access_token))throw Error("User is not in the required Discord guild")}return!0},session:async({session:e,user:r})=>(e?.user&&(e.user.id=r.id),e)}};function l(...e){return(0,s.getServerSession)(...e,u)}},84908:(e,r,t)=>{"use strict";t.d(r,{A:()=>i});var s=t(96330);let i=global.prisma||new s.PrismaClient({log:["query"]})},12963:(e,r,t)=>{"use strict";t.d(r,{m:()=>o});var s=t(33873),i=t.n(s);function o(e,r,t){return e.replace(/!\[.*?\]\((.*?)\)/g,(e,s)=>{let o=i().basename(s).toLowerCase();for(let[i,a]of t.entries())if(i.toLowerCase()===o)return e.replace(s,`${r}${a}`);return e})}},80688:(e,r,t)=>{"use strict";t.d(r,{A:()=>n});var s=t(29021),i=t.n(s),o=t(33873),a=t.n(o);function n(e,r,t,s=!0){if(!Array.isArray(t)||0===t.length)throw Error("Extensions must be a non-empty array");let o=t.join("|");if(!RegExp(`^[^/\\\\:*?"<>|]+\\.(${o})$`).test(r))throw Error(`Invalid filename. Allowed extensions: ${t.join(", ")}`);let u=a().resolve(e,r);if(!u.startsWith(e))throw Error("Invalid file path");if(s&&!i().existsSync(u))throw Error("File not found");return u}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,5452,6622,903],()=>t(37027));module.exports=s})();