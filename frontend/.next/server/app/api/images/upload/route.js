(()=>{var e={};e.id=2976,e.ids=[2976],e.modules={96330:e=>{"use strict";e.exports=require("@prisma/client")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},12412:e=>{"use strict";e.exports=require("assert")},79428:e=>{"use strict";e.exports=require("buffer")},55511:e=>{"use strict";e.exports=require("crypto")},94735:e=>{"use strict";e.exports=require("events")},29021:e=>{"use strict";e.exports=require("fs")},79748:e=>{"use strict";e.exports=require("fs/promises")},81630:e=>{"use strict";e.exports=require("http")},55591:e=>{"use strict";e.exports=require("https")},33873:e=>{"use strict";e.exports=require("path")},11723:e=>{"use strict";e.exports=require("querystring")},79551:e=>{"use strict";e.exports=require("url")},28354:e=>{"use strict";e.exports=require("util")},74075:e=>{"use strict";e.exports=require("zlib")},57730:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>D,routeModule:()=>j,serverHooks:()=>b,workAsyncStorage:()=>q,workUnitAsyncStorage:()=>I});var s={};t.r(s),t.d(s,{POST:()=>w});var i=t(42706),a=t(28203),n=t(45994),o=t(39187),u=t(84908),c=t(29021),p=t.n(c),d=t(33873),l=t.n(d),g=t(79748),m=t(85562),f=t(30379),x=t(80688);let v=f.z.instanceof(File).refine(e=>["image/jpeg","image/png","image/webp","image/svg+xml"].includes(e.type),{message:"Invalid image type, we only accept jpg, jpeg, png, webp or svg"}).refine(e=>e.size<=0xa00000,{message:"Image size is too large. Max size is 10MB"}),h=f.z.object({image:v,title:f.z.string().min(1,{message:"Title cannot be empty"}).max(200,{message:"Title is too long"}),description:f.z.string().min(1,{message:"Description cannot be empty"}).max(500,{message:"Description is too long"}),event:f.z.string().transform(e=>{try{return JSON.parse(e)}catch{throw Error("Invalid JSON format for event")}}).refine(e=>"object"==typeof e&&null!==e,{message:"Event must be a valid JSON object"}),date:f.z.string().refine(e=>"Invalid Date"!==new Date(e).toString(),{message:"Invalid Date"})}),y=l().join(process.cwd(),"/uploads/gallery/"),w=async e=>{let r;try{let e=await (0,m.j)();if(!e)return o.NextResponse.json({error:"Unauthorized. Please login."},{status:401});r=e.user?.id}catch(e){return e instanceof Error&&console.error(e.message),o.NextResponse.json({status:"error",message:"Error Validating User"})}try{let t=await e.formData(),s={image:t.get("image"),title:t.get("title"),description:t.get("description"),event:t.get("event"),date:t.get("date")},{image:i,title:a,description:n,event:c,date:d}=h.parse(s),m=Buffer.from(await i.arrayBuffer()),f=i.name.substring(0,i.name.lastIndexOf(".")),v=(0,x.A)(y,i.name,["jpg","jpeg","png","webp","svg"],!1),w=v.substring(0,v.lastIndexOf("."));for(;p().existsSync(v);)w+="1",f+="1",v=w+l().extname(v);if(f+=l().extname(v),await (0,g.writeFile)(v,m),!c.id){let e=await u.A.events.create({data:{title:c.title,userId:r}});c.id=e.id}return await u.A.gallery.create({data:{title:a,description:n,date:new Date(d),image:f,type:"CTF",events:{connect:{id:c.id}},user:{connect:{id:r}}}}),o.NextResponse.json({status:"success",message:"Image uploaded successfully"})}catch(e){if(e instanceof Error&&console.error(e.message),e instanceof f.z.ZodError){let r=e.issues.map(e=>e.message).join(", ");return o.NextResponse.json({message:r,status:"error"},{status:400})}return o.NextResponse.json({status:"error",message:"Internal Server Error"},{status:500})}},j=new i.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/images/upload/route",pathname:"/api/images/upload",filename:"route",bundlePath:"app/api/images/upload/route"},resolvedPagePath:"C:\\Users\\czhon\\Documents\\GitHub\\SSMCT_Website\\frontend\\src\\app\\api\\images\\upload\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:q,workUnitAsyncStorage:I,serverHooks:b}=j;function D(){return(0,n.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:I})}},96487:()=>{},78335:()=>{},85562:(e,r,t)=>{"use strict";t.d(r,{$:()=>u,j:()=>c});var s=t(51825),i=t(64912),a=t(86259),n=t(84908);let o=async e=>{let r=process.env.DISCORD_GUILD_ID,t=await fetch("https://discord.com/api/v10/users/@me/guilds",{headers:{Authorization:`Bearer ${e}`}});if(!t.ok)throw console.error("Failed to fetch user's Discord guilds"),Error("Failed to fetch user's Discord guilds");return!!(await t.json()).some(e=>e.id===r)||(console.error("User is not in the required Discord guild"),!1)},u={adapter:(0,a.y)(n.A),pages:{signIn:"/",signOut:"/auth/signout",error:"/auth/signin",newUser:"/auth/new_user"},session:{strategy:"database"},providers:[(0,i.A)({clientId:process.env.DISCORD_CLIENT_ID,clientSecret:process.env.DISCORD_CLIENT_SECRET,authorization:{params:{scope:"identify guilds guilds.members.read"}},token:"https://discord.com/api/oauth2/token",userinfo:"https://discord.com/api/users/@me",profile:e=>({id:e.id,name:e.username,image:e.avatar?`https://cdn.discordapp.com/avatars/${e.id}/${e.avatar}.png`:null})})],callbacks:{async signIn({account:e,user:r}){if(!e||!r)return!1;if("discord"===e.provider){if(console.log(e),!e.access_token)return!1;if(!await o(e.access_token))throw Error("User is not in the required Discord guild")}return!0},session:async({session:e,user:r})=>(e?.user&&(e.user.id=r.id),e)}};function c(...e){return(0,s.getServerSession)(...e,u)}},84908:(e,r,t)=>{"use strict";t.d(r,{A:()=>i});var s=t(96330);let i=global.prisma||new s.PrismaClient({log:["query"]})},80688:(e,r,t)=>{"use strict";t.d(r,{A:()=>o});var s=t(29021),i=t.n(s),a=t(33873),n=t.n(a);function o(e,r,t,s=!0){if(!Array.isArray(t)||0===t.length)throw Error("Extensions must be a non-empty array");let a=t.join("|");if(!RegExp(`^[a-zA-Z0-9_\\-]+\\.(${a})$`).test(r))throw Error(`Invalid filename. Allowed extensions: ${t.join(", ")}`);let u=n().resolve(e,r);if(!u.startsWith(e))throw Error("Invalid file path");if(s&&!i().existsSync(u))throw Error("File not found");return u}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[638,5452,6622,903],()=>t(57730));module.exports=s})();